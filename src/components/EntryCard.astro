---
import VideoEmbed from "./VideoEmbed.astro";
import AudioPlayer from "./AudioPlayer.astro";
import MoodBoard from "./MoodBoard.astro";
import type { CollectionEntry } from "astro:content";
import { render } from "astro:content";

interface Props {
  entry: CollectionEntry<"entries">;
}

const { entry } = Astro.props;
const { data } = entry;
const { Content } = await render(entry);

const entryId = `entry-${data.date.toISOString().split('T')[0]}-${entry.id}`;

const formattedDate = data.date.toLocaleDateString("en-US", {
  year: "numeric",
  month: "long",
  day: "numeric",
  timeZone: "UTC",
});

const videoUrls = data.videoUrl
  ? Array.isArray(data.videoUrl) ? data.videoUrl : [data.videoUrl]
  : [];

const audioUrls = data.audioUrl
  ? Array.isArray(data.audioUrl) ? data.audioUrl : [data.audioUrl]
  : [];
---

<article class="entry-card" id={entryId}>
  <header>
    <time datetime={data.date.toISOString()}>{formattedDate}</time>
    <h2><a href={`/entry/${entry.id}`}>{data.title}</a></h2>
  </header>

  {videoUrls.length > 0 && (
    <div class:list={["video-grid", { "single": videoUrls.length === 1 }]}>
      {videoUrls.map((url) => <VideoEmbed url={url} />)}
    </div>
  )}

  {audioUrls.length > 0 && (
    <div class="audio-list">
      {audioUrls.map((url) => <AudioPlayer url={url} />)}
    </div>
  )}

  {data.moodboard && data.moodboard.length > 0 && (
    <MoodBoard items={data.moodboard} />
  )}

  <div class="entry-notes">
    <Content />
  </div>

  <div class="artist-lightbox">
    <button class="artist-lightbox-close" aria-label="Close">&times;</button>
    <img class="artist-lightbox-img" />
    <p class="artist-lightbox-caption"></p>
  </div>
</article>

<style>
  .entry-card {
    margin-bottom: 3rem;
    padding-bottom: 3rem;
    border-bottom: 1px solid #eee;
  }

  .entry-card:last-child {
    border-bottom: none;
  }

  header {
    margin-bottom: 1rem;
  }

  time {
    font-size: 0.85rem;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }

  h2 {
    margin: 0.25rem 0 0;
    font-size: 1.5rem;
    font-weight: 600;
  }

  h2 a {
    color: inherit;
    text-decoration: none;
  }

  h2 a:hover {
    text-decoration: underline;
    text-underline-offset: 3px;
  }

  .video-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
    margin: 1rem 0;
  }

  .video-grid.single {
    grid-template-columns: 1fr;
    max-width: 640px;
  }

  .video-grid :global(.video-embed) {
    margin: 0;
  }

  @media (max-width: 600px) {
    .video-grid {
      grid-template-columns: 1fr;
    }

    .video-grid.single {
      max-width: 100%;
    }
  }

  .entry-notes {
    margin-top: 1rem;
    line-height: 1.7;
    color: #333;
  }

  .entry-notes :global(p) {
    margin: 0.75rem 0;
  }

  .entry-notes :global(ul),
  .entry-notes :global(ol) {
    padding-left: 1.5rem;
  }

  .entry-notes :global(a) {
    color: #2563eb;
    text-decoration-thickness: 1px;
    text-underline-offset: 2px;
  }

  .entry-notes :global(code) {
    background: #f3f4f6;
    padding: 0.15em 0.35em;
    border-radius: 3px;
    font-size: 0.9em;
  }

  .entry-notes :global(h2) {
    font-size: 1rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #666;
    margin: 2rem 0 0.75rem;
  }

  .entry-notes :global(.svg-cover-grid) {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 0.5rem;
    margin: 0 0 1.5rem;
  }

  .entry-notes :global(.svg-cover) {
    text-align: center;
  }

  .entry-notes :global(.svg-cover img) {
    width: 100%;
    aspect-ratio: 1;
    object-fit: cover;
    display: block;
    border-radius: 4px;
    background: #f0f0f0;
  }

  .entry-notes :global(.svg-cover span) {
    display: block;
    font-size: 0.65rem;
    color: #888;
    margin-top: 0.25rem;
    line-height: 1.3;
  }

  .entry-notes :global(.artist-grid) {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 0.75rem;
    margin: 0 0 1.5rem;
  }

  .entry-notes :global(.artist-card) {
    border-radius: 6px;
    overflow: hidden;
    background: #f8f8f8;
  }

  .entry-notes :global(.artist-card img) {
    width: 100%;
    aspect-ratio: 1;
    object-fit: cover;
    display: block;
  }

  .entry-notes :global(.artist-card .artist-info) {
    padding: 0.5rem 0.6rem;
  }

  .entry-notes :global(.artist-card .artist-name) {
    font-weight: 600;
    font-size: 0.8rem;
    color: #222;
    margin: 0;
    line-height: 1.3;
  }

  .entry-notes :global(.artist-card .artist-name a) {
    color: inherit;
    text-decoration: none;
  }

  .entry-notes :global(.artist-card .artist-name a:hover) {
    text-decoration: underline;
  }

  .entry-notes :global(.artist-card .artist-style) {
    font-size: 0.72rem;
    color: #888;
    margin: 0.15rem 0 0;
    line-height: 1.4;
  }

  .entry-notes :global(.artist-card) {
    cursor: pointer;
    transition: transform 0.15s, box-shadow 0.15s;
  }

  .entry-notes :global(.artist-card:hover) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  /* Artist lightbox */
  .artist-lightbox {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 1000;
    background: rgba(0, 0, 0, 0.85);
    align-items: center;
    justify-content: center;
    flex-direction: column;
    padding: 2rem;
    cursor: pointer;
  }

  .artist-lightbox.active {
    display: flex;
  }

  .artist-lightbox-img {
    max-width: min(90vw, 500px);
    max-height: 75vh;
    border-radius: 8px;
    box-shadow: 0 8px 40px rgba(0, 0, 0, 0.4);
  }

  .artist-lightbox-caption {
    color: #ccc;
    font-size: 0.9rem;
    margin-top: 1rem;
    text-align: center;
  }

  .artist-lightbox-close {
    position: absolute;
    top: 1rem;
    right: 1.5rem;
    background: none;
    border: none;
    color: #fff;
    font-size: 2rem;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.15s;
  }

  .artist-lightbox-close:hover {
    opacity: 1;
  }

  @media (max-width: 600px) {
    .entry-card {
      margin-bottom: 2rem;
      padding-bottom: 2rem;
    }

    h2 {
      font-size: 1.2rem;
    }

    .entry-notes :global(h2) {
      margin: 1.5rem 0 0.5rem;
    }

    .entry-notes :global(.svg-cover-grid) {
      grid-template-columns: repeat(3, 1fr);
    }

    .entry-notes :global(.artist-grid) {
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
    }

    .entry-notes :global(.artist-card .artist-info) {
      padding: 0.4rem 0.5rem;
    }

    .entry-notes :global(.artist-card .artist-name) {
      font-size: 0.72rem;
    }

    .entry-notes :global(.artist-card .artist-style) {
      font-size: 0.65rem;
    }

    .artist-lightbox {
      padding: 1rem;
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll<HTMLElement>(".entry-card").forEach((card) => {
      const lightbox = card.querySelector<HTMLElement>(".artist-lightbox");
      if (!lightbox) return;
      const lbImg = lightbox.querySelector<HTMLImageElement>(".artist-lightbox-img")!;
      const lbCaption = lightbox.querySelector<HTMLElement>(".artist-lightbox-caption")!;

      card.querySelectorAll<HTMLElement>(".artist-card").forEach((artistCard) => {
        artistCard.addEventListener("click", (e) => {
          if ((e.target as HTMLElement).closest("a")) return;
          const img = artistCard.querySelector("img");
          const name = artistCard.querySelector(".artist-name");
          if (img) {
            lbImg.src = img.src;
            lbCaption.textContent = name?.textContent || "";
            lightbox.classList.add("active");
          }
        });
      });

      lightbox.addEventListener("click", () => {
        lightbox.classList.remove("active");
      });
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        document.querySelectorAll(".artist-lightbox.active").forEach((lb) => {
          lb.classList.remove("active");
        });
      }
    });
  });
</script>
